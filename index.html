<!DOCTYPE html>
<html lang="ru">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∏—Ç–∞–ª–∫–∞</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
    <link rel="stylesheet" href="styles.css">

</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

    <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

    <div class="sidebar" id="sidebar">
        <h2>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h2>
        <ul id="toc"></ul>
    </div>

    <div class="container">
        <h1 id="page-title">–ß–∏—Ç–∞–ª–∫–∞</h1>
        <div id="content" class="content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="controls">
            <button onclick="prevChapter()">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
            <button onclick="nextChapter()">–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂</button>
        </div>
    </div>

    <div id="floating-menu">
        <button id="arrow-toggle">></button>
        <div id="arrow-content">
            <button id="theme-toggle">üåô</button>
            <button id="increase-font">‚ûï</button>
            <button id="decrease-font">‚ûñ</button>
        </div>
    </div>

    <script>
        let chapter = 1;
        let volume = 1;
        //const totalChapters = 213; // –°–ö–û–õ–¨–ö–û –ì–õ–ê–í –í–°–ï–ì–û

        const volumes = {
            1: 10
            //2: 1
            //3: 10
        };

        /*function loadChapter(chapterNumber) {
            fetch(`chapters/chapter${chapterNumber}.txt`)
                .then(response => {
                    if (!response.ok) throw new Error('–ì–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return response.text();
                })
                .then(text => {
                    document.getElementById('content').innerText = text;
                    document.getElementById('page-title').textContent = `–ì–ª–∞–≤–∞ ${chapterNumber}`;
                    window.scrollTo(0, 0);
                    updateTOC(chapterNumber); // –û–±–Ω–æ–≤–ª—è—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏
                })
                .catch(error => {
                    document.getElementById('content').innerText = '–ì–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                });
        }*/

        function loadChapter(vol, ch) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            volume = vol;
            chapter = ch;
            
            fetch(`volumes/volume${vol}/chapter${ch}.txt`)
                .then(response => {
                    if (!response.ok) throw new Error('–ì–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return response.text();
                })
                .then(text => {
                    document.getElementById('content').innerText = text;
                    document.getElementById('page-title').textContent = `–¢–æ–º ${vol} ‚Äî –ì–ª–∞–≤–∞ ${ch}`;
                    window.scrollTo(0, 0);
                    updateTOC(vol, ch);
                })
                .catch(error => {
                    document.getElementById('content').innerText = '–ì–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                });
        }

        /*function prevChapter() {
            if (chapter > 1) {
                chapter--;
                loadChapter(chapter);
            }
        }

        function nextChapter() {
            if (chapter < totalChapters) {
                chapter++;
                loadChapter(chapter);
            }
        }*/

        function prevChapter() {
            if (chapter > 1) {
                chapter--;
            } else if (volume > 1) {
                volume--;
                chapter = volumes[volume]; // –ø–æ—Å–ª–µ–¥–Ω—è—è –≥–ª–∞–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–æ–º–∞
            }
            loadChapter(volume, chapter);
        }

        function nextChapter() {
            if (chapter < volumes[volume]) {
                chapter++;
            } else if (volume < Object.keys(volumes).length) {
                volume++;
                chapter = 1; // –ø–µ—Ä–≤–∞—è –≥–ª–∞–≤–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–æ–º–∞
            }
            loadChapter(volume, chapter);
        }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        /*function generateTOC() {
            const toc = document.getElementById('toc');
            for (let i = 1; i <= totalChapters; i++) {
                const li = document.createElement('li');
                li.textContent = `–ì–ª–∞–≤–∞ ${i}`;
                li.setAttribute("data-chapter", i);
                li.onclick = () => {
                    chapter = i;
                    loadChapter(i);
                    toggleMenu();
                };
                toc.appendChild(li);
            }
            updateTOC(chapter);
        }*/

        function generateTOC() {
            const toc = document.getElementById('toc');
            toc.innerHTML = "";
            for (let v = 1; v <= Object.keys(volumes).length; v++) {
                const volLi = document.createElement('li');
                volLi.textContent = `–¢–æ–º ${v}`;
                //const ul = document.createElement('ul');
                volLi.classList.add("volume"); // –∫–ª–∞—Å—Å —Ç–æ–º–∞
                
                const ul = document.createElement('ul');
                ul.classList.add("chapters"); // —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤
                //ul.style.display = "none"; // —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                ul.style.maxHeight = "0"; // –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ
                
                for (let c = 1; c <= volumes[v]; c++) {
                    const li = document.createElement('li');
                    li.textContent = `   ‚Ä¢ –ì–ª–∞–≤–∞ ${c}`;
                    li.setAttribute("data-volume", v);
                    li.setAttribute("data-chapter", c);
                    li.onclick = () => {
                        volume = v;
                        chapter = c;
                        loadChapter(v, c);
                        toggleMenu();
                    };
                    ul.appendChild(li);
                }

                // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–æ–º
                /*volLi.onclick = () => {
                    const isOpen = ul.style.display === "block";
                    document.querySelectorAll(".chapters").forEach(list => list.style.display = "none");
                    if (!isOpen) {
                        ul.style.display = "block";
                    }
                };*/

                volLi.onclick = (e) => {
                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ —Å–ø–∏—Å–∫–∏ –≥–ª–∞–≤
                    document.querySelectorAll(".chapters").forEach(list => {
                        if (list !== ul) {
                            list.classList.remove("open");
                            list.style.maxHeight = "0";
                        }
                    });
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
                    if (ul.classList.contains("open")) {
                        ul.classList.remove("open");
                        ul.style.maxHeight = "0";
                    } else {
                        ul.classList.add("open");
                        ul.style.maxHeight = ul.scrollHeight + "px";
                    }
                    /*ul.classList.toggle("open");*/
                };

                volLi.appendChild(ul);
                toc.appendChild(volLi);
            }
            updateTOC(volume, chapter);
        }

        /*function updateTOC(currentChapter) {
            document.querySelectorAll("#toc li").forEach(li => {
                li.classList.remove("active");
                if (parseInt(li.getAttribute("data-chapter")) === currentChapter) {
                    li.classList.add("active");
                }
            });
        }*/

        function updateTOC(currentVol, currentChapter) {
            /*document.querySelectorAll(".chapters").forEach(list => {
                list.classList.remove("open");
                list.style.maxHeight = "0px";
            });*/
            
            document.querySelectorAll("#toc li ul li").forEach(li => {
                li.classList.remove("active");
                if (
                    parseInt(li.getAttribute("data-volume")) === currentVol &&
                    parseInt(li.getAttribute("data-chapter")) === currentChapter
                ) {
                    li.classList.add("active");
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–º —Å –∞–∫—Ç–∏–≤–Ω–æ–π –≥–ª–∞–≤–æ–π
                    const chaptersList = li.closest('.chapters');
                    if (chaptersList) {
                        chaptersList.classList.add("open");
                        // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –≤—ã—Å–æ—Ç—É
                        /*const chaptersCount = volumes[currentVol];
                        const chapterHeight = 41;
                        const dynamicHeight = chaptersCount * chapterHeight + 20;
                        chaptersList.style.maxHeight = dynamicHeight + "px";*/
                        chaptersList.style.maxHeight = chaptersList.scrollHeight + "px";
                    }
                }
            });
        }

        generateTOC();
        //loadChapter(chapter);
        loadChapter(volume, chapter);

        document.addEventListener("DOMContentLoaded", () => {
            const themeToggle = document.getElementById("theme-toggle");
            const currentTheme = localStorage.getItem("theme");

            const increaseFont = document.getElementById("increase-font");
            const decreaseFont = document.getElementById("decrease-font");

            const content = document.querySelector(".content");

            const arrowToggle = document.getElementById("arrow-toggle");
            const floatingMenu = document.getElementById("floating-menu");

            arrowToggle.addEventListener("click", () => {
                floatingMenu.classList.toggle("open");
            });

            if (currentTheme === "dark") {
                themeToggle.textContent = "‚òÄÔ∏è";
            } else {
                themeToggle.textContent = "üåô";
            }

            if (currentTheme) {
                document.documentElement.setAttribute("data-theme", currentTheme);
            } else {
                document.documentElement.setAttribute("data-theme", "light");
            }

            themeToggle.addEventListener("click", () => {
                const theme = document.documentElement.getAttribute("data-theme");
                if (theme === "dark") {
                    document.documentElement.setAttribute("data-theme", "light");
                    themeToggle.textContent = "üåô";
                    localStorage.setItem("theme", "light");
                } else {
                    document.documentElement.setAttribute("data-theme", "dark");
                    themeToggle.textContent = "‚òÄÔ∏è";
                    localStorage.setItem("theme", "dark");
                }
                console.log("New theme: ", localStorage.getItem("theme")); //
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞

            let fontSize = parseInt(localStorage.getItem("fontSize")) || 22;
            content.style.fontSize = fontSize + "px";

            increaseFont.addEventListener("click", () => {
                if (fontSize < 36) {
                    fontSize += 2;
                    content.style.fontSize = fontSize + "px";
                    localStorage.setItem("fontSize", fontSize);
                }
            });

            decreaseFont.addEventListener("click", () => {
                if (fontSize > 18) {
                    fontSize -= 2;
                    content.style.fontSize = fontSize + "px";
                    localStorage.setItem("fontSize", fontSize);
                }
            });
        });
    </script>

</body>
</html>
